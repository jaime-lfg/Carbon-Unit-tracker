<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carbon Robotics Unit Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background:#000; color:#fff; padding:20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
    .title { font-size:24px; font-weight:bold; }
    .btn { background:#3b82f6; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:14px; }
    .btn:hover { background:#2563eb; }
    .btn-green { background:#10b981; }
    .btn-green:hover { background:#059669; }
    .columns { display:grid; grid-template-columns: repeat(4,1fr); gap:16px; }
    .column { background:#1f2937; border-radius:8px; padding:12px; min-height:300px; }
    .column-header { text-align:center; padding-bottom:10px; border-bottom:1px solid #374151; margin-bottom:10px; }
    .column-title { font-weight:600; }
    .unit-card { background:#3b82f6; color:#000; padding:12px; border-radius:6px; margin-bottom:8px; cursor:move; }
    .unit-card.green { background:#10b981; }
    .unit-card.gray  { background:#6b7280; }
    .unit-card.red   { background:#ef4444; }
    .unit-number { font-size:20px; font-weight:bold; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
    .modal.active { display:flex; }
    .modal-content { background:#374151; padding:24px; border-radius:8px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; margin-bottom:4px; font-size:14px; }
    .form-group input, .form-group select, .form-group textarea {
      width:100%; padding:8px; background:#1f2937; border:1px solid #4b5563; color:#fff; border-radius:4px;
    }
    .button-group { display:flex; gap:12px; margin-top:20px; }
    .button-group button { flex:1; }
    .csm-line { font-size:12px; margin-top:4px; opacity:0.9; }
    @media (max-width:768px){ .columns{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display:flex; align-items:center; gap:20px;">
        <h1 class="title">Robot Status</h1>
        <div style="background:#10b981; padding:8px 16px; border-radius:8px;">
          <div style="font-size:12px;">Active Units</div>
          <div style="font-size:24px; font-weight:bold;" id="percentage">0%</div>
        </div>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-green" onclick="showImportModal()">📊 Import from Spreadsheet</button>
        <button class="btn" onclick="showAddModal()">+ Add Unit</button>
      </div>
    </div>

    <div class="columns">
      <div class="column" data-category="active">
        <div class="column-header">
          <div class="column-title">Active-Implemented</div>
          <div style="font-size:12px; color:#9ca3af;">(<span class="count">0</span>/10)</div>
        </div>
        <div class="units-container">
          <!-- Seed examples (used only on first load; after that we load from storage) -->
          <div class="unit-card green" draggable="true" data-unit-id="R001" data-company="Earl Freeman Farms" data-config="G-200-4" data-region="USA" data-category="active">
            <div>🇺🇸 <span class="unit-number">R001</span></div>
            <div class="company-name" style="font-size:14px; margin-top:4px;">📍 Earl Freeman Farms</div>
            <div style="font-size:14px;">Config: G-200-4</div>
          </div>
          <div class="unit-card green" draggable="true" data-unit-id="S002" data-company="Biolatina Cooperativa" data-config="G-300-4" data-region="EU" data-category="active">
            <div>🇪🇺 <span class="unit-number">S002</span></div>
            <div class="company-name" style="font-size:14px; margin-top:4px;">📍 Biolatina Cooperativa</div>
            <div style="font-size:14px;">Config: G-300-4</div>
          </div>
        </div>
      </div>

      <div class="column" data-category="inactive">
        <div class="column-header">
          <div class="column-title">Inactive-Winterized</div>
          <div style="font-size:12px; color:#9ca3af;">(<span class="count">0</span>/10)</div>
        </div>
        <div class="units-container">
          <div class="unit-card gray" draggable="true" data-unit-id="R003" data-company="Agro Solutions Inc" data-config="G-400-8" data-region="USA" data-category="inactive">
            <div>🇺🇸 <span class="unit-number">R003</span></div>
            <div class="company-name" style="font-size:14px; margin-top:4px;">📍 Agro Solutions Inc</div>
            <div style="font-size:14px;">Config: G-400-8</div>
          </div>
        </div>
      </div>

      <div class="column" data-category="implementation-phase">
        <div class="column-header">
          <div class="column-title">Implementation Phase</div>
          <div style="font-size:12px; color:#9ca3af;">(<span class="count">0</span>/10)</div>
        </div>
        <div class="units-container">
          <div class="unit-card red" draggable="true" data-unit-id="S004" data-company="DanBots Agriculture" data-config="G-600-12" data-region="EU" data-category="implementation-phase">
            <div>🇩🇰 <span class="unit-number">S004</span></div>
            <div class="company-name" style="font-size:14px; margin-top:4px;">📍 DanBots Agriculture</div>
            <div style="font-size:14px;">Config: G-600-12</div>
          </div>
          <div class="unit-card red" draggable="true" data-unit-id="R005" data-company="Koetsenburg Nordic" data-config="G-300-6" data-region="EU" data-category="implementation-phase">
            <div>🇳🇴 <span class="unit-number">R005</span></div>
            <div class="company-name" style="font-size:14px; margin-top:4px;">📍 Koetsenburg Nordic</div>
            <div style="font-size:14px;">Config: G-300-6</div>
          </div>
        </div>
      </div>

      <div class="column" data-category="implementation-scheduled">
        <div class="column-header">
          <div class="column-title">Implementation Scheduled</div>
          <div style="font-size:12px; color:#9ca3af;">(<span class="count">0</span>/10)</div>
        </div>
        <div class="units-container"></div>
      </div>
    </div>
  </div>

  <!-- Add Unit Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom:20px;">Add New Unit</h2>
      <div class="form-group">
        <label>Unit Type *</label>
        <select id="unitType">
          <option value="">Select unit type</option>
          <option value="R">REAPER (R)</option>
          <option value="S">SLAYER (S)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Unit Number *</label>
        <input type="text" id="unitNumber" placeholder="e.g., 001, 12, 5">
      </div>
      <div class="form-group">
        <label>Farm Name</label>
        <input type="text" id="farmName" placeholder="Enter farm name">
      </div>
      <div class="form-group">
        <label>Configuration *</label>
        <select id="config">
          <option value="">Select configuration</option>
          <option value="G-200-3">G-200-3</option>
          <option value="G-200T-4">G-200T-4</option>
          <option value="G-300-4">G-300-4</option>
          <option value="G-300-5">G-300-5</option>
          <option value="G-300-6">G-300-6</option>
          <option value="G-400-8">G-400-8</option>
          <option value="G-600-9">G-600-9</option>
          <option value="G-600-8">G-600-8</option>
          <option value="G-600-11">G-600-11</option>
          <option value="G-600-12">G-600-12</option>
        </select>
      </div>
      <div class="form-group">
        <label>Region</label>
        <select id="region">
          <option value="">Select region</option>
          <option value="USA">USA 🇺🇸</option>
          <option value="EU">EU 🇪🇺</option>
          <option value="AUS/NZ">AUS/NZ 🇦🇺</option>
          <option value="JAPAN">JAPAN 🇯🇵</option>
          <option value="CANADA">CANADA 🇨🇦</option>
        </select>
      </div>
      <div class="button-group">
        <button class="btn btn-green" onclick="addUnit()">Add Unit</button>
        <button class="btn" style="background:#6b7280;" onclick="closeModal('addModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom:20px;">📊 Import from Spreadsheet</h2>
    <div style="background:#1e40af; padding:12px; border-radius:6px; margin-bottom:16px;">
        <p style="font-size:14px; margin-bottom:8px;">📋 Format: CSM → Unit → Customer → Region</p>
        <p style="font-size:12px; color:#fbbf24;">⚠️ Paste data directly (no headers)</p>
      </div>
      <div class="form-group">
        <label>Paste your data here:</label>
        <textarea id="importData" rows="8" placeholder="Mark Zahnlecker	S2	Grimmway	North America"></textarea>
      </div>
      <div class="button-group">
        <button class="btn btn-green" onclick="importUnits()">Import</button>
        <button class="btn" style="background:#6b7280;" onclick="closeModal('importModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal (dbl-click opens this) -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom:16px;">Edit Unit</h2>

      <div class="form-group">
        <label>Unit ID</label>
        <input id="e_unitId" type="text" readonly>
      </div>

      <div class="form-group">
        <label>Company</label>
        <input id="e_company" type="text" placeholder="Farm / Customer">
      </div>

      <div class="form-group">
        <label>Configuration</label>
        <select id="e_config">
          <option value="">Select configuration</option>
          <option>G-200-3</option><option>G-200T-4</option><option>G-300-4</option>
          <option>G-300-5</option><option>G-300-6</option><option>G-400-8</option>
          <option>G-600-9</option><option>G-600-8</option><option>G-600-11</option><option>G-600-12</option>
        </select>
      </div>

      <div class="form-group">
        <label>Region</label>
        <select id="e_region">
          <option value="">(none)</option>
          <option value="USA">USA 🇺🇸</option><option value="EU">EU 🇪🇺</option>
          <option value="AUS/NZ">AUS/NZ 🇦🇺</option><option value="JAPAN">JAPAN 🇯🇵</option>
          <option value="CANADA">CANADA 🇨🇦</option>
        </select>
      </div>

      <!-- NEW: CSM Dropdown -->
      <div class="form-group">
        <label>CSM</label>
        <select id="e_csm">
          <option value="">Unassigned</option>
          <option>Steven Sacco</option>
          <option>Fabien Dumestre</option>
          <option>Gabriel Faure</option>
          <option>Borja Arregui</option>
          <option>Maximilian Urtz</option>
          <option>Liam Hollis (</option>
          <option>Mark Zahnlecker</option>
          <option>Sean Iliff</option>
          <option>Travis Palmer</option>
          <option>Brandon Alvarez</option>
          <option>Leander Fourie</option>
          <option>Joel Thompson</option>
          <option>Tomas Vergara</option>
          <option>Borja Arregui</option>
          <option>Gabriel Muller</option>
          <option>Daniel Flach</option>
          <option>Jonathan Salzer</option>
          <option>Jakob Aarup Pedersen</option>
          <option>Luke Parsons</option>
          <option>Twan van Breukelen</option>
        </select>
      </div>

      <div class="button-group">
        <button id="e_save" class="btn btn-green">Save</button>
        <button id="e_delete" class="btn" style="background:#ef4444;">Delete</button>
        <button id="e_cancel" class="btn" style="background:#6b7280;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // =================== Persistence ===================
    const STORAGE_KEY = 'cr-unit-tracker:v1';

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
      } catch { return null; }
    }

    function saveState(units) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(units));
      } catch (e) {
        console.error('Failed to save:', e);
      }
    }

    function seedStateFromDOM() {
      const cards = Array.from(document.querySelectorAll('.unit-card'));
      return cards.map(card => ({
        id: (card.dataset.unitId || card.querySelector('.unit-number')?.textContent || '').trim(),
        company: (card.dataset.company || card.querySelector('.company-name')?.textContent?.replace('📍','') || 'Unknown').trim(),
        config: (card.dataset.config || (() => {
          const t = Array.from(card.querySelectorAll('div')).map(n => n.textContent||'').find(x => x.includes('Config:'));
          return t ? t.split('Config:').pop().trim() : 'Pending';
        })()),
        region: card.dataset.region || '',
        category: card.dataset.category || card.closest('.column')?.dataset.category || 'implementation-scheduled',
        csm: card.dataset.csm || '' // NEW
      })).filter(u => u.id);
    }

    // =================== Rendering ===================
    function countryFlag(region) {
      const map = { 'USA':'🇺🇸','EU':'🇪🇺','AUS/NZ':'🇦🇺','JAPAN':'🇯🇵','CANADA':'🇨🇦' };
      return map[region] || '🏳️';
    }

    function makeCard(item) {
      const card = document.createElement('div');
      card.className = 'unit-card';
      card.draggable = true;
      card.dataset.unitId = item.id;
      card.dataset.company = item.company || 'Unknown';
      card.dataset.config = item.config || 'Pending';
      card.dataset.region = item.region || '';
      card.dataset.category = item.category;
      card.dataset.csm = item.csm || '';

      if (item.category === 'active') card.classList.add('green');
      else if (item.category === 'inactive') card.classList.add('gray');
      else if (item.category === 'implementation-phase') card.classList.add('red');

      const csmText = item.csm && item.csm.trim() ? item.csm : 'Unassigned';

      card.innerHTML = `
        <div>${countryFlag(item.region)} <span class="unit-number">${item.id}</span></div>
        <div class="company-name" style="font-size:14px; margin-top:4px;">📍 ${item.company || 'Unknown'}</div>
        <div style="font-size:14px;">Config: ${item.config || 'Pending'}</div>
        <div class="csm-line">CSM: ${csmText}</div>
      `;
      attachDragHandlers(card);
      return card;
    }

    function renderAll(units) {
      document.querySelectorAll('.units-container').forEach(c => c.innerHTML = '');
      const byCat = {
        'active': document.querySelector('[data-category="active"] .units-container'),
        'inactive': document.querySelector('[data-category="inactive"] .units-container'),
        'implementation-phase': document.querySelector('[data-category="implementation-phase"] .units-container'),
        'implementation-scheduled': document.querySelector('[data-category="implementation-scheduled"] .units-container'),
      };
      units.forEach(u => {
        const cont = byCat[u.category] || byCat['implementation-scheduled'];
        cont.appendChild(makeCard(u));
      });
      updateCounts();
    }

    // =================== Drag & Drop ===================
    let draggedElement = null;

    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      this.style.opacity = '0.5';
    }
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      this.style.opacity = '';
    }
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      return false;
    }
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      if (draggedElement) {
        const container = this.querySelector('.units-container');
        container.appendChild(draggedElement);

        const newCat = this.dataset.category || 'implementation-scheduled';
        const id = draggedElement.dataset.unitId;
        const idx = state.findIndex(x => x.id === id);
        if (idx >= 0) {
          state[idx].category = newCat;
          saveState(state);
        }

        draggedElement.dataset.category = newCat;
        updateColorClass(draggedElement, newCat);
        updateCounts();
      }
      return false;
    }

    function attachDragHandlers(card) {
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
    }

    document.querySelectorAll('.column').forEach(column => {
      column.addEventListener('dragover', handleDragOver);
      column.addEventListener('drop', handleDrop);
    });

    function updateColorClass(card, category) {
      card.classList.remove('green','gray','red');
      if (category === 'active') card.classList.add('green');
      else if (category === 'inactive') card.classList.add('gray');
      else if (category === 'implementation-phase') card.classList.add('red');
    }

    function updateCounts() {
      document.querySelectorAll('.column').forEach(column => {
        const count = column.querySelectorAll('.unit-card').length;
        column.querySelector('.count').textContent = count;
      });
      const active = document.querySelectorAll('[data-category="active"] .unit-card').length;
      const implPhase = document.querySelectorAll('[data-category="implementation-phase"] .unit-card').length;
      const total = document.querySelectorAll('.unit-card').length;
      const percentage = total > 0 ? Math.round(((active + implPhase) / total) * 100) : 0;
      document.getElementById('percentage').textContent = percentage + '%';
    }

    function showAddModal(){ document.getElementById('addModal').classList.add('active'); }
    function showImportModal(){ document.getElementById('importModal').classList.add('active'); }
    function closeModal(id){ document.getElementById(id).classList.remove('active'); }

    // =================== Add / Import (persist) ===================
    function addUnit() {
      const unitType = document.getElementById('unitType').value;
      const unitNumber = document.getElementById('unitNumber').value.trim();
      const farmName = document.getElementById('farmName').value.trim();
      const config = document.getElementById('config').value;
      const region = document.getElementById('region').value;

      if (!unitType || !unitNumber || !config) { alert('Please fill in required fields'); return; }

      const id = `${unitType}${unitNumber}`;
      if (state.some(u => u.id === id)) { alert(`Unit ${id} already exists.`); return; }

      state.push({
        id, company: farmName || 'Unknown', config, region: region || '', category: 'implementation-scheduled', csm: ''
      });
      saveState(state);
      renderAll(state);
      closeModal('addModal');

      document.getElementById('unitType').value = '';
      document.getElementById('unitNumber').value = '';
      document.getElementById('farmName').value = '';
      document.getElementById('config').value = '';
      document.getElementById('region').value = '';
    }

    function importUnits() {
      const data = document.getElementById('importData').value;
      if (!data.trim()) { alert('Please paste data to import'); return; }

      const lines = data.trim().split('\n');
      let imported = 0;
      lines.forEach(line => {
        const parts = line.split('\t');
        if (parts.length >= 3) {
          const unit = (parts[1] || '').toUpperCase().trim();
          const customer = (parts[2] || '').trim();
          if (/^[RS]\d+$/i.test(unit) && !state.some(u => u.id === unit)) {
            state.push({
              id: unit, company: customer || 'Unknown', config: 'Pending', region: '', category: 'implementation-scheduled', csm: ''
            });
            imported++;
          }
        }
      });

      if (imported > 0) {
        saveState(state);
        renderAll(state);
        document.getElementById('importData').value = '';
        closeModal('importModal');
        alert(`Successfully imported ${imported} units`);
      } else {
        alert('No new valid units found in the data');
      }
    }

    // =================== Edit Modal (dblclick) ===================
    let editingCard = null;
    const editModal = document.getElementById('editModal');
    const e_unitId = document.getElementById('e_unitId');
    const e_company = document.getElementById('e_company');
    const e_config  = document.getElementById('e_config');
    const e_region  = document.getElementById('e_region');
    const e_csm     = document.getElementById('e_csm');
    const e_delete  = document.getElementById('e_delete');

    document.getElementById('e_cancel').onclick = () => closeEdit();
    document.getElementById('e_save').onclick   = () => saveEdit();
    e_delete.onclick = () => deleteCard();

    function openEdit(card) {
      editingCard = card;

      const id = card.dataset.unitId;
      const item = state.find(u => u.id === id);
      if (!item) return;

      e_unitId.value = item.id;
      e_company.value = item.company || '';
      e_config.value = item.config || '';
      e_region.value = item.region || '';
      e_csm.value = item.csm || '';

      editModal.classList.add('active');
    }

    function closeEdit() {
      editModal.classList.remove('active');
      editingCard = null;
    }

    function saveEdit() {
      if (!editingCard) return;
      const id = editingCard.dataset.unitId;
      const idx = state.findIndex(u => u.id === id);
      if (idx < 0) return;

      state[idx].company = e_company.value.trim();
      state[idx].config  = e_config.value;
      state[idx].region  = e_region.value;
      state[idx].csm     = e_csm.value; // NEW

      saveState(state);
      renderAll(state);
      closeEdit();
    }

    function deleteCard() {
      if (!editingCard) return;
      const id = editingCard.dataset.unitId || 'this unit';
      if (!confirm(`Delete ${id}? This cannot be undone.`)) return;

      const idx = state.findIndex(u => u.id === id);
      if (idx >= 0) {
        state.splice(idx, 1);
        saveState(state);
        renderAll(state);
      }
      closeEdit();
    }

    // Open edit on double-click (works for all cards via delegation)
    document.addEventListener('dblclick', (e) => {
      const card = e.target.closest('.unit-card');
      if (!card) return;
      if (card.classList.contains('dragging')) return; // ignore mid-drag
      e.preventDefault();
      e.stopPropagation();
      openEdit(card);
    });

    // =================== Boot ===================
    let state = loadState();
    if (!state) {
      state = seedStateFromDOM();
      saveState(state);
    }
    renderAll(state);
  </script>
</body>
</html>
